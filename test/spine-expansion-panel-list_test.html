<!DOCTYPE html>
<!--
  ~ Copyright (c) 2000-2018 TeamDev. All rights reserved.
  ~ TeamDev PROPRIETARY and CONFIDENTIAL.
  ~ Use is subject to license terms.
  -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>spine-expansion-panel-list test</title>

  <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>
  <script src="../node_modules/wct-browser-legacy/browser.js"></script>

  <script type="module" src="../spine-expansion-panel-list.js"></script>
</head>
<body>
<script>
  const testItems = [
    {name: 'spine-expansion-panel-list', url: 'https://github.com/SpineElements/spine-expansion-panel-list'},
    {name: 'spine-test-helpers', url: 'https://github.com/SpineElements/spine-test-helpers'},
    {name: 'spine-avatar', url: 'https://github.com/SpineElements/spine-avatar'},
    {name: 'spine-badge', url: 'https://github.com/SpineElements/spine-badge'},
    {name: 'spine-item-elements', url: 'https://github.com/SpineElements/spine-item-elements'},
    {name: 'spine-color-picker', url: 'https://github.com/SpineElements/spine-color-picker'},
    {name: 'spine-contraster', url: 'https://github.com/SpineElements/spine-contraster'},
    {name: 'spine-icon-button', url: 'https://github.com/SpineElements/spine-icon-button'},
    {name: 'spine-button', url: 'https://github.com/SpineElements/spine-button'},
    {name: 'spine-context-menu', url: 'https://github.com/SpineElements/spine-context-menu'},
    {name: 'spine-social-button', url: 'https://github.com/SpineElements/spine-social-button'},
    {name: 'spine-doc-generator', url: 'https://github.com/SpineElements/spine-doc-generator'},
    {name: 'spine-attachment', url: 'https://github.com/SpineElements/spine-attachment'},
    {name: 'spine-tags', url: 'https://github.com/SpineElements/spine-tags'}
  ];
</script>

<script type="module">
  import {LitElement, html} from '@polymer/lit-element';
  import '../spine-expansion-panel-list.js';

  class TestElementContainer extends LitElement {
    constructor() {
      super();
      this.items = testItems;
    }
    _render() {
      return html`
        <div id="list-container">
          <spine-expansion-panel-list id="list"
            items="${this.items}"
            renderCollapsedItem="${item => html`
              <div class="collapsed-test-item">
                <div>[[item.name]]</div>
                <a href="${item.url}">GitHub page</a>
              </div>
            `}"
            renderExpandedItem="${item => html`
              <div class="expanded-test-item">
                <h2>[[item.name]]</h2>
                <a href="${item.url}">GitHub page</a>
              </div>
            `}"
          </spine-expansion-panel-list>
        </div>
      `;
    }
  }
  window.customElements.define('test-element-container', TestElementContainer);
</script>

<test-fixture id="test-setup">
  <template>
    <test-element-container></test-element-container>
  </template>
</test-fixture>

<script type="module">
  import {
    runAsyncChain, checkNodes, Checkers
  } from '../node_modules/spine-test-helpers/spine-test-helpers.js';
  import {flush} from '@polymer/polymer/lib/utils/flush.js';

  suite('<spine-expansion-panel-list>', function() {
    let listContainer;
    let list;

    const classNames = {
      item: '-spine-expansion-panel-list-item',
      collapsedItemContent: 'collapsed-test-item',
      expandedItemContent: 'expanded-test-item',
    };

    // size in pixels by which an expanded item's left/right edges stand out relative to the side
    // edges of collapsed items.
    const defaultItemExpansionSize = 20;
    // vertical distance in pixels between an expanded item and adjacent collapsed ones
    const defaultExpandedItemVertMargin = 16;

    Object.assign(Checkers || {}, {
      collapsedItemContents: itemModel => Checkers.element({
        name: 'div',
        hasClassNames: [classNames.collapsedItemContent],
        childNodes: [
          Checkers.element({
            name: 'div',
            innerHTML: itemModel.name
          }),
          Checkers.element({
            name: 'a',
            properties: {href: itemModel.url},
            innerHTML: 'GitHub page'
          })
        ]
      }),

      expandedItemContents: itemModel => Checkers.element({
        name: 'div',
        hasClassNames: [classNames.expandedItemContent],
        childNodes: [
          Checkers.element({
            name: 'h2',
            innerHTML: itemModel.name
          }),
          Checkers.element({
            name: 'a',
            properties: {href: itemModel.url},
            innerHTML: 'GitHub page'
          })
        ]
      }),

      itemLayout: (expanded, prevItemBottomEdge, firstItem) => (itemElement, message) => {
        const containerRect = listContainer.getBoundingClientRect();
        const expansionHorizOffset = expanded ? 0 : defaultItemExpansionSize;
        const expansionVertOffset = firstItem
            ? 0 /* expanded item's top margin collapses for the first item */
            : expanded ? defaultExpandedItemVertMargin : 0;
        Checkers.element({
          borderBox: {
            top: prevItemBottomEdge + expansionVertOffset,
            left: containerRect.left + expansionHorizOffset,
            right: containerRect.right - expansionHorizOffset,
          }
        })(itemElement, message);
      }
    });

    function checkListItemsLayout(expandedItemIndex) {
      let prevSiblingBottomEdge = listContainer.getBoundingClientRect().top;
      const itemElements = list.querySelectorAll(`.${classNames.item}`);
      itemElements.forEach((itemElement, itemIndex) => {
        const expanded = itemIndex === expandedItemIndex;
        Checkers.itemLayout(expanded, prevSiblingBottomEdge, itemIndex === 0)
          (itemElement, `Checking alignment of item at index ${itemIndex}`);
        prevSiblingBottomEdge =
            itemElement.getBoundingClientRect().bottom +
            (expanded ? defaultExpandedItemVertMargin : 0);
      });
    }

    setup(() => {
      const testContainer = fixture('test-setup');
      flush();

      listContainer = testContainer.shadowRoot.querySelector('#list-container');
      list = listContainer.querySelector('#list');
    });

    test('defaults are correct', () => {
      debugger;
      const expandedItem = list.expandedItem;
      assert.isTrue(expandedItem === null || expandedItem === undefined,
          `expecting expandedItem to be null or undefined by default: ${expandedItem}`);
      assert.equal(list.items, testItems, 'Item assigned are preserved');
    });

    test('number of rendered items is correct (all items collapsed)', () => {
      const collapsedItems = list.querySelectorAll(`.${classNames.collapsedItemContent}`);
      const expandedItems = list.querySelectorAll(`.${classNames.expandedItemContent}`);
      assert.equal(collapsedItems.length, testItems.length,
          'Checking the number of collapsed items');
      assert.equal(expandedItems.length, 0, 'Checking the number of expanded items');
    });

    test('number of rendered items is correct (contains an expanded item)', () => {
      list.expandedItem = testItems[1];
      assert.equal(list.expandedItem, testItems[1],
          'Checking that `expandedItem` property is set correctly');
      flush();
      const collapsedItems = list.querySelectorAll(`.${classNames.collapsedItemContent}`);
      const expandedItems = list.querySelectorAll(`.${classNames.expandedItemContent}`);
      assert.equal(collapsedItems.length, testItems.length - 1,
          'Checking the number of collapsed items');
      assert.equal(expandedItems.length, 1, 'Checking the number of expanded items');
    });

    test('rendered item contents are correct', () => {
      const checkItemContents = (expandedItemIndex, message) => {
        const itemElements = list.querySelectorAll(
            `.${classNames.collapsedItemContent}, .${classNames.expandedItemContent}`);
        checkNodes(itemElements, null, testItems.map((itemModel, itemIndex) =>
            itemIndex === expandedItemIndex
                ? Checkers.expandedItemContents(itemModel)
                : Checkers.collapsedItemContents(itemModel)
        ), message);
      };

      // first, check the default expansion state
      checkItemContents(-1, 'Checking rendered item contents with all items collapsed');

      // expand items one by one and check the rendered contents on each stage
      testItems.forEach((item, itemIndex) => {
        list.expandedItem = testItems[itemIndex];
        assert.equal(list.expandedItem, testItems[itemIndex],
            `Checking that expandedItem property is set correctly (itemIndex=${itemIndex})`);
        flush();
        checkItemContents(itemIndex,
            `Checking rendered item contents (expanded item index is ${itemIndex})`);
      });

      // set an item that is not included in the items list and check the rendered contents
      const itemNotInTheList = {name: 'Item not in the list', url: 'http://localhost:8080'};
      list.expandedItem = itemNotInTheList;
      assert.equal(list.expandedItem, itemNotInTheList,
          'Checking that expanded item is preserved for "extraneous" items');
      flush();
      checkItemContents(-1,
          'Checking rendered item contents when an "extraneous" item is requested to be expanded');
    });

    test('collapsed items layout is correct', () => {
      assert.isTrue(listContainer.offsetWidth > 100,
          'Ensure that testing conditions are fine (we have enough width for displaying items)');
      checkListItemsLayout(-1);
    });

    test('expanded item layout is correct', done => {
      const asyncCalls = [];
      testItems.forEach((item, itemIndex) => {
        asyncCalls.push(() => {
          list.expandedItem = item;
          flush();
        });
        asyncCalls.push(() => {
          checkListItemsLayout(itemIndex);
        })
      });
      asyncCalls.push(() => done());
      runAsyncChain({retryTimeout: 2000}, ...asyncCalls);
    });

  });
</script>
</body>
</html>
